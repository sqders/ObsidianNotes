## Что такое CSRF

**CSRF** (от англ. cross-site request forgery) или межсайтовая подделка запроса – это форма атаки на любой сайт или веб-приложение. С помощью подделки запросов мошенник обманом заставляет пользователя выполнять нежелательные действия на, казалось бы, проверенной платформе.

## Как работает CSRF-атака

Межсайтовая подделка запроса будет работать только в том случае, если потенциальная жертва авторизована. Благодаря этому злоумышленник может обойти процесс аутентификации, чтобы войти в веб-приложение.

![](https://www.nic.ru/help/upload/image/unnamed%20(30).png)

Выполнение CSRF-атаки состоит из двух основных частей.

1. Злоумышленник заставляет жертву щёлкнуть на ссылку или загрузить веб-страницу. Он намеренно заманивает пользователя перейти по ссылке, используя методы социальной инженерии.
2. Отправляет «поддельный» или выдуманный запрос в браузер жертвы. Вредоносная ссылка отправит запрос в веб-приложение, однако будет включать в себя значения, которые выгодны злоумышленнику.

Этот запрос определяется как незаконный, поскольку жертва не знает, что он отправляется. Но для веб-сервера это выглядит так, как будто пользователь отправил его, потому что он включает в себя файлы cookie, которые необходимы веб-серверу для проверки личности жертвы.

## Что такое токен CSRF

Токен CSRF – это уникальное и непредсказуемое значение, которое сервер генерирует для защиты уязвимых перед CSRF ресурсов.

После выполнения запроса приложение на стороне сервера сравнивает два маркера, найденные в сеансе пользователя и в самом запросе. Если токен отсутствует или не соответствует значению в сеансе пользователя, запрос отклоняется, сеанс пользователя завершается, а событие регистрируется как потенциальная атака CSRF. Так злоумышленнику практически невозможно создать полный действительный запрос, чтобы заманить жертву.

## Требования к токену:

- Уникальный токен для каждой операции
- Действует единожды
- Имеет размер, устойчивый к подбору
- Сгенерирован криптографически стойким генератором псевдослучайных чисел
- Имеет ограниченное время жизни

### Synchronizer Tokens
Простой подход, использующийся повсеместно. Требует хранения токена на стороне сервера.
###### Суть:
1. При **старте сессии** на стороне сервера генерируется токен.
2. Токен кладется в хранилище данных сессии (_т.е. сохраняется на стороне сервера для последующей проверки_)
3. В ответ на запрос (_который стартовал сессию_) клиенту возвращается токен.
Если **рендеринг происходит на сервере**, то токен может возвращаться внутри HTML, как, например, одно из полей формы, или внутри `<meta>` тега.
В случае, если ответ возвращается **для JS приложения**, токен можно передавать в header (_часто для этого используют `X-CSRF-Token`_)
4. При последующих запросах клиент обязан передать токен серверу для проверки.
При рендере контента сервером токен принято возвращать **внутри POST данных** формы.
JS приложения обычно присылают **XHR запросы с header** (`X-CSRF-Token`), содержащим токен.
1. При получения запроса небезопасным методом (`POST`, `PUT`, `DELETE`, `PATCH`) сервер обязан проверить на идентичность токен **из данных сессии** и токен, который **прислал клиент**.
Если оба токена совпадают, то запрос не подвергся CSRF-Атаке, в ином случае — логируем событие и отклоняем запрос.